<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²ç¤ºæ¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* ======================================================= */
        /* ğŸ¨ ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ å®šç¾© (ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰) */
        /* ======================================================= */
        :root {
            --primary-color: #007bff;        /* é’ç³» (ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ) */
            --primary-hover: #0056b3;
            --background-color: #f4f7f6;     /* ãƒšãƒ¼ã‚¸èƒŒæ™¯ */
            --container-bg: #ffffff;         /* ã‚³ãƒ³ãƒ†ãƒŠ/æŠ•ç¨¿èƒŒæ™¯ */
            --form-bg: #e9ecef;              /* ãƒ•ã‚©ãƒ¼ãƒ èƒŒæ™¯ */
            --text-color: #212529;           /* æ¨™æº–ãƒ†ã‚­ã‚¹ãƒˆ */
            --secondary-text: #495057;       /* è£œåŠ©ãƒ†ã‚­ã‚¹ãƒˆ */
            --border-color: #ced4da;
            --post-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --info-text: #6c757d;
            --id-color: #dc3545;             /* èµ¤ç³» (IDå¼·èª¿) */
            --error-color: #dc3545;
            --message-bg: #fff0f0;
            --input-focus-shadow: rgba(0, 123, 255, 0.5);
        }
        
        /* ======================================================= */
        /* ğŸŒ™ ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ å®šç¾© (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
        /* ======================================================= */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #6caceb;        /* æ˜ã‚‹ã„é’ */
                --primary-hover: #4a8ac2;
                --background-color: #121212;     /* æ¿ƒã„èƒŒæ™¯ */
                --container-bg: #1e1e1e;         /* ã‚³ãƒ³ãƒ†ãƒŠ/æŠ•ç¨¿èƒŒæ™¯ */
                --form-bg: #2d2d2d;              /* ãƒ•ã‚©ãƒ¼ãƒ èƒŒæ™¯ */
                --text-color: #e0e0e0;           /* æ˜ã‚‹ã„ãƒ†ã‚­ã‚¹ãƒˆ */
                --secondary-text: #b0b0b0;       /* è£œåŠ©ãƒ†ã‚­ã‚¹ãƒˆ */
                --border-color: #444444;
                --post-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                --info-text: #999999;
                --id-color: #ff7f7f;
                --error-color: #ff7f7f;
                --message-bg: #3c2a2a;
                --input-focus-shadow: rgba(108, 172, 235, 0.5);
            }
        }

        /* ======================================================= */
        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        /* ======================================================= */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            min-height: 100vh;
            background-color: var(--background-color);
            color: var(--text-color);
            padding: 20px; 
            transition: background-color 0.4s, color 0.4s;
        }
        
        .container {
            max-width: 960px; 
            margin: 0 auto;
            background: var(--container-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--post-shadow);
            transition: background 0.4s, box-shadow 0.4s;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ« */
        h1 {
            color: var(--primary-color);
            text-align: center;
            font-weight: 700;
            padding-bottom: 15px;
            margin-bottom: 25px;
            border-bottom: 3px solid var(--primary-color);
            font-size: 2em;
        }

        h2 {
            color: var(--text-color);
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 1.4em;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        /* æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        #post-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--form-bg);
            border-radius: 8px;
            transition: background 0.4s;
        }

        /* å…¥åŠ›ã‚°ãƒ«ãƒ¼ãƒ— (UIå¼·åŒ–) */
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px; /* å†…éƒ¨ã®éš™é–“ */
            padding: 10px;
            border: 1px dashed var(--border-color); /* ã‚°ãƒ«ãƒ¼ãƒ—ã®è¦–è¦šçš„ãªåŒºåˆ‡ã‚Š */
            border-radius: 5px;
        }
        
        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
        #post-form input[type="text"], 
        #post-form textarea {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            background: var(--container-bg);
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;
            width: 100%; /* ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§å…¨å¹… */
        }
        #post-form input[type="text"]:focus, 
        #post-form textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px var(--input-focus-shadow);
            outline: none;
        }
        #post-form textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* æŠ•ç¨¿ãƒœã‚¿ãƒ³ (UIå¼·åŒ–: ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿) */
        #post-form button {
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.1s, opacity 0.3s;
            display: flex; /* ã‚¢ã‚¤ã‚³ãƒ³é…ç½®ã®ãŸã‚ */
            align-items: center;
            justify-content: center;
        }
        #post-form button span {
            margin-left: 8px; /* ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã®é–“éš” */
            font-size: 1.2em;
        }
        #post-form button:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }
        #post-form button:disabled {
            background-color: var(--border-color);
            color: var(--secondary-text);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* æŠ•ç¨¿ã‚¨ãƒªã‚¢ (å¤‰æ›´ãªã—) */
        #posts-container {
            display: flex;
            flex-direction: column; 
            gap: 15px;
            margin-top: 20px;
        }
        .post {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s, box-shadow 0.2s, background 0.4s;
        }
        .post:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* æŠ•ç¨¿ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .post-number {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary-color);
            margin-right: 15px;
            flex-shrink: 0;
        }
        .post-name {
            font-size: 1.05em;
            font-weight: 700;
            color: var(--text-color);
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .post-info {
            text-align: right;
            font-size: 0.8em;
            color: var(--info-text);
            line-height: 1.4;
            flex-shrink: 0;
            margin-left: 15px;
        }
        .post-body {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            color: var(--secondary-text);
            font-size: 16px;
        }
        .public-id {
            font-weight: 600;
            color: var(--id-color);
            font-family: monospace;
            display: block;
        }

        /* ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (å¤‰æ›´ãªã—) */
        #cooldown-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--message-bg);
            color: var(--error-color);
            border: 1px solid var(--error-color);
            padding: 12px 18px;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s, transform 0.5s;
            transform: translateY(-20px);
            font-weight: 700;
        }
        #cooldown-message.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ©ãƒ™ãƒ« (å¤‰æ›´ãªã—) */
        #enable-enter-submit {
            transform: scale(1.0);
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        #post-form label {
            color: var(--secondary-text);
            font-size: 14px;
        }

        /* ======================================================= */
        /* ğŸ“± ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ (ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å‘ã‘) */
        /* ======================================================= */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                border-radius: 0; 
                box-shadow: none;
            }
            .post-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .post-name {
                white-space: normal; 
                overflow: visible;
                text-overflow: clip;
                width: 100%;
                order: 2; 
            }
            .post-info {
                text-align: left;
                margin-left: 0;
                width: 100%;
                order: 3;
            }
            .post-number {
                order: 1;
            }
            #cooldown-message {
                top: auto;
                bottom: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>æ²ç¤ºæ¿</h1>

        <form id="post-form">
            <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿</h2>
            
            <div class="input-group">
                <input type="text" id="name" placeholder="åå‰">
                <textarea id="body" placeholder="æœ¬æ–‡" required></textarea>
            </div>
            
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0 5px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="enable-enter-submit" checked>
                    <label for="enable-enter-submit">Enterã‚­ãƒ¼ã§é€ä¿¡</label>
                </div>
                
                <button type="submit">
                    æŠ•ç¨¿
                    <span aria-hidden="true">&#10148;</span> </button>
            </div>
            
        </form>

        <h2>ç¨¿ä¸€è¦§</h2>
        <div id="posts-container">
            <p id="loading-message">æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>
    
    <div id="cooldown-message" class=""></div>

    <script>
        let lastFetchedCount = 0; 
        const REFRESH_INTERVAL = 5000; 
        
        const POST_COOLDOWN_MS = 5000; 
        let lastPostTime = 0;
        let isSubmitting = false; 

        // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showCooldownMessage(remainingSeconds) {
            const messageElement = document.getElementById('cooldown-message');
            messageElement.textContent = `ã‚ã¨${remainingSeconds}ç§’å¾…ã£ã¦ãã ã•ã„ã€‚`;
            messageElement.classList.add('visible');
            
            // 3ç§’å¾Œã«éè¡¨ç¤ºã«ã™ã‚‹
            setTimeout(() => {
                messageElement.classList.remove('visible');
            }, 3000); 
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/[&<>"']/g, function(match) {
                switch (match) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return match;
                }
            });
        }


        async function fetchPosts(forceRefresh = false) {
            const container = document.getElementById('posts-container');
            
            if (forceRefresh || lastFetchedCount === 0) {
                container.innerHTML = '<p id="loading-message">æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
            }

            try {
                // ä»®ã®APIãƒ‘ã‚¹ã€‚å®Ÿéš›ã®å®Ÿè£…ã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
                const response = await fetch(`/api/bbs/posts`); 
                if (!response.ok) {
                    let errorDetails = { detail: `HTTP ${response.status} ã‚¨ãƒ©ãƒ¼` };
                    try {
                        errorDetails = await response.json();
                    } catch (e) {
                        
                    }
                    throw new Error(errorDetails.detail || `HTTP ${response.status} ã‚¨ãƒ©ãƒ¼`);
                }
                
                const data = await response.json();
                
                let posts = data.posts || []; 

                // ã€âœ… ä¿®æ­£ç‚¹ 1ã€‘ æŠ•ç¨¿ç•ªå·ã‚’å¤ã„é †ã«ã™ã‚‹ãŸã‚ã€ã¾ãšé…åˆ—ã‚’æ™‚é–“é †ï¼ˆæ˜‡é †ï¼å¤ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆã™ã‚‹
                posts.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

                const currentCount = posts.length;

                if (!forceRefresh && currentCount === lastFetchedCount && lastFetchedCount !== 0) {
                    return;
                }

                lastFetchedCount = currentCount;

                if (posts.length === 0) {
                    container.innerHTML = '<p id="empty-message">ã¾ã æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã©ã†ãï¼</p>';
                    return;
                }

                container.innerHTML = '';
                
                
                // ã€âœ… ä¿®æ­£ç‚¹ 2ã€‘ æŠ•ç¨¿ã‚’æ ¼ç´ã™ã‚‹ä¸€æ™‚é…åˆ—ã‚’ä½œæˆã—ã€ç•ªå·ã‚’æŒ¯ã‚‹
                const numberedPosts = posts.map((post, index) => {
                    // å¤ã„é †ã« No.1, No.2 ã¨ãªã‚‹
                    const postNumber = index + 1; 
                    return { ...post, number: postNumber };
                });

                // ã€âœ… ä¿®æ­£ç‚¹ 3ã€‘ è¡¨ç¤ºã¯æœ€æ–°ã®ã‚‚ã®ãŒä¸Šã«ãªã‚‹ã‚ˆã†ã«ã€ç•ªå·ã‚’æŒ¯ã£ãŸé…åˆ—ã‚’é€†é †ã«ã™ã‚‹
                const reversedPosts = numberedPosts.reverse();

                reversedPosts.forEach((post) => {
                    const postNumber = post.number; // å¤ã„é †ã«æŒ¯ã‚‰ã‚ŒãŸç•ªå·ã‚’ä½¿ç”¨

                    const postElement = document.createElement('div');
                    postElement.classList.add('post');

                    const formattedDate = new Date(post.created_at).toLocaleString('ja-JP', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    const safeName = escapeHTML(post.name || "åç„¡ã—");
                    const safeBody = escapeHTML(post.body || "");

                    postElement.innerHTML = `
                        <div class="post-header">
                            <span class="post-number">No.${postNumber}</span>
                            <span class="post-name">${safeName}</span>
                            <div class="post-info">
                                <span>${formattedDate}</span>
                                <span class="public-id">#${post.public_id}</span>
                            </div>
                        </div>
                        <div class="post-body">${safeBody}</div>
                    `;
                    // reversedPosts ã¯æœ€æ–°é †ãªã®ã§ã€appendChildã§è¿½åŠ ã™ã‚‹ã¨æœ€æ–°ã®ã‚‚ã®ãŒä¸€ç•ªä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹
                    container.appendChild(postElement);
                });

            } catch (error) {
                console.error("æŠ•ç¨¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                container.innerHTML = `<p style="color: var(--error-color); background: var(--message-bg); border-radius: 6px; padding: 20px; border: 1px solid var(--error-color);">
                    ğŸš¨ æŠ•ç¨¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}
                </p>`;
            }
        }
        
        function startAutoRefresh() {
            fetchPosts(true);
            setInterval(fetchPosts, REFRESH_INTERVAL);
        }

        function handleEnterKey(event) {
            const isEnterSubmitEnabled = document.getElementById('enable-enter-submit').checked;
            const bodyInput = document.getElementById('body');
            
            if (event.key === 'Enter' && isEnterSubmitEnabled) {
                if (!event.shiftKey) {
                    
                    const now = Date.now();
                    const body = bodyInput.value.trim();
                    const isCooldown = (now - lastPostTime < POST_COOLDOWN_MS);

                    if (isCooldown || isSubmitting || !body) {
                        event.preventDefault(); 
                        if (isCooldown) {
                            const remainingSeconds = ((lastPostTime + POST_COOLDOWN_MS - now) / 1000).toFixed(1);
                            showCooldownMessage(remainingSeconds); 
                        }
                        return; 
                    }

                    event.preventDefault();
                    document.getElementById('post-form').requestSubmit();
                }
            }
        }
        document.getElementById('body').addEventListener('keydown', handleEnterKey);


        async function submitPost(event) {
            event.preventDefault();

            const nameInput = document.getElementById('name');
            const bodyInput = document.getElementById('body');
            const submitButton = document.querySelector('#post-form button');

            const name = nameInput.value.trim();
            const body = bodyInput.value.trim();

            if (!body) {
                alert("æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            
            if (body.length > 200) {
                alert(`æœ¬æ–‡ã¯200æ–‡å­—ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ ${body.length} æ–‡å­—ã§ã™ã€‚`);
                return;
            }
            
            const now = Date.now();
            if (now - lastPostTime < POST_COOLDOWN_MS) {
                const remainingSeconds = ((lastPostTime + POST_COOLDOWN_MS - now) / 1000).toFixed(1);
                showCooldownMessage(remainingSeconds);
                return;
            }

            isSubmitting = true;
            submitButton.disabled = true;
            submitButton.innerHTML = 'é€ä¿¡ä¸­...';

            try {
                // ä»®ã®APIãƒ‘ã‚¹ã€‚å®Ÿéš›ã®å®Ÿè£…ã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
                const response = await fetch(`/api/bbs/post`, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: name, body: body }),
                });

                if (!response.ok) {
                    let errorData = { detail: `æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: ${response.status}` };
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        
                    }
                    throw new Error(errorData.detail || `æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }

                
                
                bodyInput.value = '';

                lastPostTime = Date.now(); 
                
                await fetchPosts(true);

            } catch (error) {
                console.error("æŠ•ç¨¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
                alert(`æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`); 
                
            } finally {
              
